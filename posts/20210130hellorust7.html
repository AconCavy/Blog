<!DOCTYPE html>

<html lang="ja">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline';
img-src 'self' * data: *.w3.org; 
child-src 'none';
frame-src 'self' *.twitter.com;
font-src 'self' *.fontawesome.com *.typekit.net;
connect-src 'self' *.fontawesome.com *.typekit.net; style-src 'self' 'unsafe-inline' stackpath.bootstrapcdn.com;
script-src 'self' 'unsafe-eval' cdn.jsdelivr.net stackpath.bootstrapcdn.com *.fontawesome.com cdnjs.cloudflare.com *.twitter.com *.typekit.net;">

    <link rel="icon" href="/Blog/assets/favicon.ico"/>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">
    <link rel="stylesheet" href="/Blog/css/style.css" type="text/css">

    <title>acon.log - Rust&#x306E;&#x304A;&#x52C9;&#x5F37;&#x30E1;&#x30E2;7 (&#x30C6;&#x30B9;&#x30C8;)</title>

    
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="acon.log">
<meta property="og:title" content="Rust&#x306E;&#x304A;&#x52C9;&#x5F37;&#x30E1;&#x30E2;7 (&#x30C6;&#x30B9;&#x30C8;)">
<meta property="og:description" content="">
<meta property="og:image" content="https://aconcavy.github.io/Blog/assets/icon.webp">
<meta property="og:url" content="/Blog/posts/20210130hellorust7">

    <script src="/Blog/js/adobe_fonts.js"></script>

</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm" id="mainNav">
    <div class="container">
        <a class="navbar-brand" href="/Blog/">acon.log</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
    <li class="nav-item">
        <a class="nav-link" href="/Blog/posts">Posts</a>
    </li>
</ul>
        </div>
    </div>
</nav>

<header>
</header>

<div class="container">
    <div class="row">
        <div id="content">

                <div class="card shadow-sm">
                    <div class="card-body p-md-5">
                        
<div class="post-header">
    <div class="row">
        <div class="col-md-12">
            <h1 class="card-title">Rust&#x306E;&#x304A;&#x52C9;&#x5F37;&#x30E1;&#x30E2;7 (&#x30C6;&#x30B9;&#x30C8;)</h1>

            <div class="card-text post-meta">Published on Saturday, 30 January 2021</div>
            <div class="card-text post-meta">Updated on Tuesday, 02 February 2021</div>

                <div class="mt-3">
                        <a href="/Blog/tags/rust" class="badge badge-light"> Rust</a>
                </div>
        </div>
    </div>
</div>

<hr>

                        <div class="post-body">
                            <h1 id="section">はじめに</h1>
<p><a href="https://doc.rust-jp.rs/book-ja/">The Rust Programming Language 日本語版</a> で学んだことのメモ7です。</p>
<ul>
<li><a href="20210128hellorust1">メモ1</a></li>
<li><a href="20210128hellorust2">メモ2</a></li>
<li><a href="20210128hellorust3">メモ3</a></li>
<li><a href="20210129hellorust4">メモ4</a></li>
<li><a href="20210129hellorust5">メモ5</a></li>
<li><a href="20210130hellorust6">メモ6</a></li>
<li>メモ7 (ここ)</li>
</ul>
<p><a href="https://github.com/AconCavy/hello_rust">リポジトリ</a> (12章以降)</p>
<h1 id="section-1">テスト</h1>
<h2 id="section-2">テストの記述法</h2>
<ol>
<li>必要なデータや状態をセットアップする。</li>
<li>テスト対象のコードを実行する。</li>
<li>結果が想定通りであることを断定する。</li>
</ol>
<h2 id="section-3">テスト関数の構成</h2>
<p>テスト対象となる関数に <code>test</code> 属性を付けることで、<code>cargo test</code> コマンドでテストを実行できる。
<code>panic!</code> マクロを使うことで、テストを強制的に失敗させることもできる。</p>
<pre><code class="language-rust line-numbers">#[cfg(test)]
mod tests{
    #[test]
    fn it_works() {
        assert_eq!(2 + 2, 4);
    }

    #[test]
    fn fail() {
        panic!(&quot;fail&quot;);
    }
}
</code></pre>
<h2 id="assert">assert!マクロ</h2>
<p><code>assert!</code> マクロは標準ライブラリで提供され、テスト内の条件が <code>true</code> と評価されることを確かめることができる。 テスト内の条件が <code>false</code> の場合、テストは失敗する。</p>
<pre><code class="language-rust line-numbers">#[cfg(test)]
mod tests{
    #[test]
    fn success() {
        assert!(true);
    }

    #[test]
    fn fail() {
        assert!(false);
    }
}
</code></pre>
<h2 id="assert_eqassert_ne">assert_eq!とassert_ne!マクロ</h2>
<p><code>assert_eq!</code> マクロは、二つの引数を比べて等しいことを評価し、 <code>assert_ne!</code> マクロは、二つの引数を比べて等しくないことを評価する。
内部的にはそれぞれ <code>==</code> と <code>!=</code> 演算子を使用している。比較対象の値は <code>PartialEq</code> と <code>Debug</code> トレイトを実装していなければならない。 (オリジナルの構造体やenumには<code>#[derive(PartialEq, Debug)]</code> という注釈を追加することで利用可能。)</p>
<pre><code class="language-rust line-numbers">#[cfg(test)]
mod tests{
    #[test]
    fn eq_success() {
        assert_eq!(2 + 2, 4);
    }

    #[test]
    fn eq_fail() {
        assert_eq!(2 + 3, 4);
    }

    #[test]
    fn eq_success() {
        assert_ne!(2 + 3, 4);
    }

    #[test]
    fn eq_fail() {
        assert_ne!(2 + 2, 4);
    }
}
</code></pre>
<h2 id="section-4">カスタムの失敗メッセージ</h2>
<p><code>assert!</code> 、 <code>assert_eq!</code> 、 <code>assert_ne!</code> の追加引数として、カスタムメッセージを指定できる。</p>
<pre><code class="language-rust line-numbers">#[cfg(test)]
mod tests {
    #[test]
    fn custom_message() {
        let actual = String::from(&quot;hello&quot;);
        let expected = String::from(&quot;world&quot;);
        assert_eq!(actual, expected, &quot;actual is {}&quot;, actual);
    }
}
</code></pre>
<h2 id="should_panic">should_panic</h2>
<p><code>should_panic</code> 属性をテスト対象の関数に追加することで、パニックが発生しない場合にはテストを失敗させることができる。
<code>should_panic</code> 属性に、 <code>expected</code> 引数を追加して、失敗メッセージに与えられたテキストが含まれているかを評価することもできる。</p>
<pre><code class="language-rust line-numbers">#[cfg(test)]
mod tests {
    #[test]
    #[should_panic]
    fn expect_panic() {
        panic!(&quot;foo&quot;);
    }

    #[test]
    #[should_panic(expected = &quot;foo&quot;)]
    fn expect_panic_with_text() {
        panic!(&quot;foo&quot;);
    }
}
</code></pre>
<h2 id="resultt-e">Result&lt;T, E&gt;</h2>
<p><code>Result&lt;T, E&gt;</code> を使ったテストを書くこともできる。
テストが成功すれば <code>Ok</code> を、 失敗すればパニックの代わりに <code>Err</code> を返す。
<code>?</code> 演算子をテストの中で使えるようになる。
<code>should_panic</code> 属性は使えない。</p>
<pre><code class="language-rust line-numbers">#[cfg(test)]
mod tests {
    #[test]
    fn return_result() -&gt; Result&lt;(), String&gt; {
        if 2 + 2 == 4 {
            Ok(())
        } else {
            Err(String::from(&quot;error&quot;))
        }
    }
}
</code></pre>
<h2 id="section-5">テストの実行のされ方を制御する</h2>
<p><code>cargo test</code> にオプションを指定することで動作を変更することができる。</p>
<h3 id="section-6">テストを並行または連続して実行する</h3>
<p>標準では複数のテストを実行するとスレッドを使用して並列に実行されるが、 <code>--test-threads</code> オプションを指定することで、実行されるスレッド数を指定できる。</p>
<pre><code class="line-numbers">cargo test -- --test-threads=1
</code></pre>
<h3 id="section-7">関数の出力を表示する</h3>
<p><code>println!</code> の出力は、テストでは表示されないため、 <code>--nocapture</code> オプションを指定することで、出力を表示できる。</p>
<pre><code class="line-numbers">cargo test -- --nocapture
</code></pre>
<h3 id="section-8">名前でテストの一部を実行する</h3>
<p>テストの関数名を指定することで、テストを個別に実施することができる。
テスト名の一部を指定できるため、その値に合致するあらゆるテストが実行される。</p>
<pre><code class="line-numbers">cargo test some_

running 2 tests
test tests::some_function_1 ... ok
test tests::some_function_2 ... ok
</code></pre>
<h3 id="section-9">テストを無視する</h3>
<p>テストに <code>ignore</code> 属性を追加すると、テストを除外することができる。</p>
<pre><code class="language-rust line-numbers">#[cfg(test)]
mod tests {
    #[test]
    #[ignore]
    fn ignored_function() { // 実行されない
        assert!(true);
    }
}
</code></pre>
<p><code>--ignored</code> オプションを指定すると、 <code>ignore</code> 属性が追加されたテストのみが実行される。</p>
<pre><code class="line-numbers">cargo test -- --ignored

running 1 tests
test tests::ignored_function ... ok
</code></pre>
<h2 id="section-10">テストの体系化</h2>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>テスト</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>単体テスト</td>
<td>個別に1回に1モジュールをテストし、非公開のインターフェースもテストすることがある。</td>
</tr>
<tr>
<td>結合テスト</td>
<td>公開インターフェイスのみ使用する。1テストにつき複数のモジュールを用いることもある。</td>
</tr>
</tbody>
</table>
</div>
<h3 id="section-11">単体テスト</h3>
<p>テスト対象となるコードとともに、 <code>src</code> ディレクトリの各ファイルに置く。非公開関数もテストできる。
慣習として、各ファイルに <code>tests</code> という名前のモジュールを作り、テスト関数を含ませ、そのモジュールを <code>cfg(test)</code> で注釈する。</p>
<p><code>cfg(test)</code> 注釈を付与したモジュールは、 <code>cargo test</code> コマンド実行時のみコンパイルが実行されるようになる。</p>
<h3 id="section-12">結合テスト</h3>
<p>Rustにおける結合テストは、完全にライブラリ外のものである。
結合テストを作成するには、 <code>tests</code> ディレクトリを作成する。</p>
<pre><code class="line-numbers">sample/
|- src/
|  |- main.rs
|  |- lib.rs
|
|- tests/
   |- foo_test.rs
</code></pre>
<p>Cargoは <code>tests</code> ディレクトリを特別に扱い、 <code>cargo test</code> コマンド実行時のみディレクトリ内のファイルをコンパイルするため、 <code>#[cfg(test)]</code> 注釈は必要ない。</p>
<pre><code class="language-rust line-numbers">extern crate sample;

#[test]
fn foo() {
    assert!(sample::foo());
}
</code></pre>
<h4 id="section-13">結合テスト内のサブモジュール</h4>
<p><code>tests</code> ディレクトリの各ファイルは個別のクレートとしてコンパイルされる。
また、 <code>tests</code> ディレクトリのサブディレクトリ内のファイルは個別のクレートとしてコンパイルされたり、テスト出力に区域が表示されることはない。</p>
<h4 id="section-14">バイナリクレート用の結合テスト</h4>
<p>ライブラリクレートのみが、他のクレートが使用できる関数をさらすことができるため、 <code>main.rs</code> ファイルに定義された関数をインポートすることはできない。</p>

                        </div>
                        <div class="post-footer mt-5">
    <div class="share">
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" url="/Blog/posts/20210130hellorust7" data-size="large">
            Tweet
        </a>
    </div>

    <hr>

    <div class="row justify-content-center m-3 about">
        <div class="col-md-3 mt-3">
            <img class="rounded-circle" src="/Blog/assets/icon.webp" alt="icon"/>
        </div>
        <div class="col-md-3 mt-3">
            <div class="col">
                <h5>AconCavy</h5>
                <div class="profile">
                    C#が好きなひきニート
                </div>
            </div>
            <div class="col">
                <a class="nav-link fab fa-twitter fa-2x" href="https://twitter.com/AconCavy"></a>
                <a class="nav-link fab fa-github fa-2x" href="https://github.com/AconCavy"></a>
            </div>
        </div>
    </div>
</div>
                    </div>
                </div>

        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <p>Copyright © 2021 AconCavy</p>
                <ul class="list-inline text-center small">
                        <li class="list-inline-item">
                            <a href="/Blog/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        </li>
                        <li class="list-inline-item">
                            <a href="/Blog/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        </li>
                </ul>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js" integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/" crossorigin="anonymous"></script>

<script src="https://kit.fontawesome.com/defa8b99ee.js" crossorigin="anonymous"></script>

<script src="/Blog/prism/prism.js"></script>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

</body>

</html>